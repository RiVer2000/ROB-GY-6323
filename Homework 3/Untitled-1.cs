                +---------------------------+
                | Start `cost_to_go(stage, x)` |
                +---------------------------+
                           |
                           v
               +-------------------------+
               | Check if (stage, x) is in memo |
               +-------------------------+
                           |
                Yes       /         \       No
               +--------------------------+ 
               |  Retrieve j_min, u_opt    |     
               |  from memo and return     |
               +--------------------------+
                           |
                           v
                      +------------+
                      | Base case: |
                      | Is stage == 3?   |
                      +------------+
                           |
                 Yes      /         \       No
               +-------------------------------+
               | Compute j_min = x^2, u_opt = None |
               +-------------------------------+
                           |
                           v
                 +------------------------+
                 | Store in memo and return |
                 +------------------------+
                           |
                           v
                   +------------------+
                   | Initialize j_min |
                   | to infinity      |
                   +------------------+
                           |
                           v
                +-----------------------------+
                | For each u_i in U_POSS      |
                +-----------------------------+
                           |
                           v
               +--------------------------------------+
               | Compute next_x = system_model(x, u_i) |
               +--------------------------------------+
                           |
                           v
         +------------------------------------------+
         | Compute j_i = cost_func(x, u_i) +       |
         |          cost_to_go(stage + 1, next_x)[0] |
         +------------------------------------------+
                           |
                           v
              +--------------------------+
              | If j_i < j_min           |
              +--------------------------+
                /          |            \
               Yes       /                \       No
       +-------------------+               |
       | Set j_min = j_i   |               |
       | Set u_opt = u_i   |               |
       +-------------------+               |
                           |
                           v
                +----------------------------+
                | After loop, store j_min and |
                | u_opt in memo for (stage, x)|
                +----------------------------+
                           |
                           v
                +------------------------+
                | Return j_min, u_opt    |
                +------------------------+


                   +----------------------------------+
                   | For each control input u_i in    |
                   | U_POSS, calculate the total cost |
                   +----------------------------------+
                               |
                               v
              +--------------------------------------+
              | Compute next_x = system_model(x, u_i) |
              +--------------------------------------+
                               |
                               v
              +------------------------------------------+
              | Recursive call:                         |
              | cost_to_go(stage + 1, next_x)           |
              +------------------------------------------+
                               |
                               v
              +------------------------------------------+
              | Calculate total cost j_i =               |
              | cost_func(x, u_i) + cost_to_go[0]        |
              +------------------------------------------+
                               |
                               v
                    +--------------------------+
                    | If j_i < j_min           |
                    +--------------------------+
                               |
                     Yes      /          \     No
              +--------------------------+    |
              | Update j_min and u_opt   |    |
              +--------------------------+    |
                               |
                               v
                    (Repeat for all u_i in U_POSS)

                       +---------------------------+
                       | Start from final stage,   |
                       | backtrack using memo      |
                       +---------------------------+
                                |
                                v
                    +-----------------------------+
                    | For each preceding stage    |
                    | Retrieve j_min, u_opt from   |
                    | memo for optimal path       |
                    +-----------------------------+
                                |
                                v
                    +-----------------------------+
                    | Move to previous stage      |
                    | with optimal control u_opt  |
                    +-----------------------------+
                                |
                                v
                      +-------------------+
                      | Continue until    |
                      | initial stage     |
                      +-------------------+
                                |
                                v
                      +-------------------+
                      | End of backtracking |
                      +-------------------+
